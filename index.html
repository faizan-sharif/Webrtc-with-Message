<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WebRTC Messenger</title>
<link rel="icon" type="image/png" href="logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0a0a0f;
    --surface:  #111118;
    --panel:    #16161f;
    --border:   #252535;
    --accent:   #7c6dfa;
    --accent2:  #fa6d8c;
    --green:    #4dffa0;
    --yellow:   #ffd24d;
    --text:     #e8e8f0;
    --muted:    #6b6b80;
    --font-mono: 'JetBrains Mono', monospace;
    --font-ui:   'Syne', sans-serif;
    --r: 10px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-ui);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }


  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(124,109,250,.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,109,250,.04) 1px, transparent 1px);
    background-size: 32px 32px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    background: rgba(17,17,24,.85);
    backdrop-filter: blur(12px);
  }
  .logo {
    font-size: 1.1rem; font-weight: 800; letter-spacing: -.02em;
    display: flex; align-items: center; gap: 8px;
  }
  .logo span.dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 10px var(--accent);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; transform: scale(1); }
    50%      { opacity: .6; transform: scale(1.3); }
  }

  #status-badge {
    font-family: var(--font-mono);
    font-size: .72rem; font-weight: 600;
    padding: 4px 12px; border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--surface);
    transition: all .3s;
  }
  #status-badge.ws     { border-color: var(--yellow);  color: var(--yellow); }
  #status-badge.ready  { border-color: var(--green);   color: var(--green);  }
  #status-badge.error  { border-color: var(--accent2); color: var(--accent2); }

  main {
    position: relative; z-index: 1;
    display: grid;
    grid-template-columns: 280px 1fr;
    flex: 1; height: calc(100vh - 57px);
    overflow: hidden;
  }

  aside {
    border-right: 1px solid var(--border);
    background: var(--panel);
    display: flex; flex-direction: column;
    padding: 20px;
    gap: 20px;
    overflow-y: auto;
  }
  .section-label {
    font-size: .65rem; letter-spacing: .12em; text-transform: uppercase;
    color: var(--muted); font-weight: 700; margin-bottom: 6px;
  }

  .field { display: flex; flex-direction: column; gap: 6px; }
  input[type=text] {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    color: var(--text);
    font-family: var(--font-mono); font-size: .8rem;
    padding: 9px 12px;
    outline: none; transition: border-color .2s;
    width: 100%;
  }
  input[type=text]:focus { border-color: var(--accent); }

  .btn {
    font-family: var(--font-ui); font-weight: 700; font-size: .8rem;
    padding: 10px 16px; border-radius: var(--r);
    border: none; cursor: pointer; transition: all .2s;
    letter-spacing: .04em;
    width: 100%;
  }
  .btn-primary {
    background: var(--accent); color: #fff;
  }
  .btn-primary:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  .btn-danger {
    background: transparent;
    border: 1px solid var(--accent2);
    color: var(--accent2);
  }
  .btn-danger:hover { background: rgba(250,109,140,.15); }

  .arch-diagram {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 12px;
    font-family: var(--font-mono); font-size: .65rem;
    color: var(--muted); line-height: 1.8;
  }
  .arch-diagram .step { display: flex; gap: 6px; align-items: flex-start; }
  .arch-diagram .step.active .arrow { color: var(--green); }
  .arch-diagram .step.active .label { color: var(--text); }
  .arrow { color: var(--border); transition: color .3s; }
  .label { transition: color .3s; }

  #stats-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 12px;
    font-family: var(--font-mono); font-size: .68rem;
    line-height: 2; color: var(--muted);
  }
  #stats-box .row { display: flex; justify-content: space-between; }
  #stats-box .val { color: var(--text); }
  #stats-box .val.ok  { color: var(--green); }
  #stats-box .val.bad { color: var(--accent2); }

  .chat-wrap {
    display: flex; flex-direction: column; overflow: hidden;
  }

  #messages {
    flex: 1; overflow-y: auto;
    padding: 20px 24px;
    display: flex; flex-direction: column; gap: 10px;
    scroll-behavior: smooth;
  }
  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg {
    max-width: 68%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: .88rem; line-height: 1.5;
    animation: msgIn .25s ease both;
    word-break: break-word;
  }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .msg.mine {
    align-self: flex-end;
    background: var(--accent);
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .msg.theirs {
    align-self: flex-start;
    background: var(--panel);
    border: 1px solid var(--border);
    border-bottom-left-radius: 4px;
  }
  .msg-meta {
    font-size: .6rem; font-family: var(--font-mono);
    margin-top: 4px; opacity: .55;
    text-align: right;
  }
  .msg.theirs .msg-meta { text-align: left; }

  .sys-msg {
    align-self: center;
    font-family: var(--font-mono); font-size: .68rem;
    color: var(--muted);
    padding: 4px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    animation: msgIn .2s ease both;
  }
  .sys-msg.ok   { color: var(--green); border-color: rgba(77,255,160,.3); }
  .sys-msg.warn { color: var(--yellow); border-color: rgba(255,210,77,.3); }
  .sys-msg.err  { color: var(--accent2); border-color: rgba(250,109,140,.3); }
  .input-bar {
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    display: flex; gap: 10px; align-items: flex-end;
    background: rgba(17,17,24,.9);
    backdrop-filter: blur(12px);
  }
  #msg-input {
    flex: 1;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: var(--font-ui); font-size: .9rem;
    padding: 10px 16px;
    outline: none; resize: none;
    transition: border-color .2s;
    max-height: 120px; overflow-y: auto;
    line-height: 1.5;
  }
  #msg-input:focus { border-color: var(--accent); }
  #msg-input:disabled { opacity: .4; }
  #msg-input::placeholder { color: var(--muted); }

  #send-btn {
    width: 44px; height: 44px; border-radius: 12px;
    background: var(--accent);
    border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .2s; flex-shrink: 0;
  }
  #send-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
  #send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  #send-btn svg { fill: #fff; }

  #empty-state {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 10px; color: var(--muted);
    font-family: var(--font-mono); font-size: .8rem; text-align: center;
  }
  #empty-state svg { opacity: .2; }
  #empty-state p { max-width: 220px; line-height: 1.7; }

  #typing-indicator {
    padding: 4px 24px;
    font-family: var(--font-mono); font-size: .68rem;
    color: var(--muted); min-height: 22px;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="dot"></span>
    WebRTC Messenger
  </div>
  <span id="status-badge">Disconnected</span>
</header>

<main>

  <aside>
    <div>
      <div class="section-label">Room</div>
      <div class="field" style="gap:10px">
        <input type="text" id="room-input" placeholder="e.g. alpha-01" maxlength="32" />
        <button class="btn btn-primary" id="join-btn">Join Room</button>
        <button class="btn btn-danger" id="leave-btn" disabled>Leave</button>
      </div>
    </div>

    <div>
      <div class="section-label">ICE Handshake</div>
      <div class="arch-diagram" id="arch">
        <div class="step" id="step-ws">
          <span class="arrow">â†’</span>
          <span class="label">Signal WS connect</span>
        </div>
        <div class="step" id="step-stun">
          <span class="arrow">â†’</span>
          <span class="label">STUN: who am I?</span>
        </div>
        <div class="step" id="step-offer">
          <span class="arrow">â†’</span>
          <span class="label">Offer SDP</span>
        </div>
        <div class="step" id="step-answer">
          <span class="arrow">â†’</span>
          <span class="label">Answer SDP</span>
        </div>
        <div class="step" id="step-ice-a">
          <span class="arrow">â†’</span>
          <span class="label">ICE cands (A)</span>
        </div>
        <div class="step" id="step-ice-b">
          <span class="arrow">â†’</span>
          <span class="label">ICE cands (B)</span>
        </div>
        <div class="step" id="step-dc">
          <span class="arrow">â†’</span>
          <span class="label">DataChannel open</span>
        </div>
      </div>
    </div>


    <div>
      <div class="section-label">Connection Info</div>
      <div id="stats-box">
        <div class="row"><span>Role</span><span class="val" id="stat-role">â€”</span></div>
        <div class="row"><span>ICE state</span><span class="val" id="stat-ice">â€”</span></div>
        <div class="row"><span>DC state</span><span class="val" id="stat-dc">â€”</span></div>
        <div class="row"><span>Sent</span><span class="val" id="stat-sent">0</span></div>
        <div class="row"><span>Received</span><span class="val" id="stat-recv">0</span></div>
      </div>
    </div>
  </aside>


  <div class="chat-wrap">
    <div id="messages">
      <div id="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
        <p>Enter a room ID and click <strong>Join Room</strong> to start a peer-to-peer session.</p>
      </div>
    </div>
    <div id="typing-indicator"></div>
    <div class="input-bar">
      <textarea id="msg-input" placeholder="Type a messageâ€¦" rows="1" disabled></textarea>
      <button id="send-btn" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</main>

<script>

const SIGNAL_URL = `ws://${location.host}`;


const ICE_SERVERS = [

  { urls: "stun:stun.l.google.com:19302" },
  { urls: "stun:stun1.l.google.com:19302" },

];

let ws = null, pc = null, dc = null;
let isInitiator = false;
let sentCount = 0, recvCount = 0;
let typingTimer = null;
let pendingCandidates = [];


const $ = id => document.getElementById(id);
const statusBadge   = $("status-badge");
const joinBtn       = $("join-btn");
const leaveBtn      = $("leave-btn");
const roomInput     = $("room-input");
const msgInput      = $("msg-input");
const sendBtn       = $("send-btn");
const messagesEl    = $("messages");
const emptyState    = $("empty-state");
const typingEl      = $("typing-indicator");

function setStatus(text, cls = "") {
  statusBadge.textContent = text;
  statusBadge.className = cls;
}

function activateStep(id) {
  const el = $(id);
  if (el) el.classList.add("active");
}

function addMsg(text, type = "sys", variant = "") {
  emptyState && emptyState.remove();
  const now = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  if (type === "sys") {
    const div = document.createElement("div");
    div.className = `sys-msg ${variant}`;
    div.textContent = text;
    messagesEl.appendChild(div);
  } else {
    const wrap = document.createElement("div");
    wrap.className = `msg ${type}`;
    wrap.innerHTML = `${text}<div class="msg-meta">${now}</div>`;
    messagesEl.appendChild(wrap);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function setStat(id, val, cls = "") {
  const el = $(id);
  if (!el) return;
  el.textContent = val;
  el.className = `val ${cls}`;
}

function enableChat(on) {
  msgInput.disabled = !on;
  sendBtn.disabled  = !on;
  if (on) msgInput.focus();
}

function connectSignal(roomId) {
  ws = new WebSocket(SIGNAL_URL);

  ws.onopen = () => {
    setStatus("Signal connected", "ws");
    activateStep("step-ws");
    ws.send(JSON.stringify({ type: "join", roomId }));
  };

  ws.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);
    console.log("[signal â†]", msg.type, msg);

    switch (msg.type) {
      case "joined":
        isInitiator = msg.isInitiator;
        setStat("stat-role", isInitiator ? "Initiator (A)" : "Responder (B)");
        addMsg(`Joined room "${roomId}" as ${isInitiator ? "Peer A (initiator)" : "Peer B"}`, "sys", "ok");
        setStatus(`Room: ${roomId}`, "ws");
        initPeerConnection();
        if (!isInitiator) {

          addMsg("Waiting for Peer A to connectâ€¦", "sys");
        }
        break;

      case "peer-joined":
        addMsg("Peer joined! Creating offerâ€¦", "sys", "ok");
        await createOffer();
        break;

      case "offer":
        await handleOffer(msg.sdp);
        break;

      case "answer":
        await handleAnswer(msg.sdp);
        break;

      case "ice-candidate":
        await addIceCandidate(msg.candidate);
        break;

      case "peer-left":
        addMsg("Peer disconnected.", "sys", "warn");
        setStatus(`Room: ${roomId} (alone)`, "ws");
        setStat("stat-ice", "â€”");
        setStat("stat-dc", "â€”");
        enableChat(false);
        break;

      case "error":
        addMsg(`Error: ${msg.message}`, "sys", "err");
        break;
    }
  };

  ws.onclose = () => {
    setStatus("Disconnected", "error");
    addMsg("Signal server disconnected.", "sys", "err");
  };

  ws.onerror = () => {
    setStatus("WS Error", "error");
    addMsg("Cannot reach the signaling server. Is server.js running?", "sys", "err");
  };
}

function wsSend(msg) {
  if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(msg));
}

function initPeerConnection() {
  pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

  pc.onicecandidate = ({ candidate }) => {
    if (!candidate) return;
    activateStep(isInitiator ? "step-ice-a" : "step-ice-b");
    wsSend({ type: "ice-candidate", candidate });
  };

  pc.onicegatheringstatechange = () => {
    if (pc.iceGatheringState === "gathering") activateStep("step-stun");
  };

  pc.oniceconnectionstatechange = () => {
    const s = pc.iceConnectionState;
    setStat("stat-ice", s, s === "connected" || s === "completed" ? "ok" : s === "failed" ? "bad" : "");
    if (s === "connected" || s === "completed") {
      setStatus("Connected âœ“", "ready");
    }
  };


  pc.ondatachannel = ({ channel }) => {
    dc = channel;
    setupDataChannel();
  };


  if (isInitiator) {
    dc = pc.createDataChannel("chat", { ordered: true });
    setupDataChannel();
  }
}

function setupDataChannel() {
  setStat("stat-dc", "connecting");

  dc.onopen = () => {
    activateStep("step-dc");
    setStat("stat-dc", "open", "ok");
    setStatus("Connected âœ“", "ready");
    enableChat(true);
    addMsg("ðŸ”’ Peer-to-peer channel open. Messages are end-to-end (no relay).", "sys", "ok");
  };

  dc.onclose = () => {
    setStat("stat-dc", "closed", "bad");
    enableChat(false);
  };

  dc.onmessage = ({ data }) => {
    const parsed = JSON.parse(data);
    if (parsed.type === "typing") {
      showTyping(parsed.on);
      return;
    }
    recvCount++;
    setStat("stat-recv", recvCount);
    addMsg(parsed.text, "theirs");
  };
}

async function createOffer() {
  activateStep("step-offer");
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  wsSend({ type: "offer", sdp: pc.localDescription });
  addMsg("Offer SDP sent via Signal channel.", "sys");
}

async function handleOffer(sdp) {
  activateStep("step-offer");
  await pc.setRemoteDescription(new RTCSessionDescription(sdp));
  for (const c of pendingCandidates) await pc.addIceCandidate(new RTCIceCandidate(c));
  pendingCandidates = [];
  activateStep("step-answer");
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  wsSend({ type: "answer", sdp: pc.localDescription });
  addMsg("Answer SDP sent via Signal channel.", "sys");
}

async function handleAnswer(sdp) {
  activateStep("step-answer");
  await pc.setRemoteDescription(new RTCSessionDescription(sdp));
}

async function addIceCandidate(candidate) {
  if (!pc || !pc.remoteDescription) {
    pendingCandidates.push(candidate);
    return;
  }
  try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); }
  catch (e) { console.warn("ICE candidate error:", e); }
}

function sendMessage() {
  const text = msgInput.value.trim();
  if (!text || !dc || dc.readyState !== "open") return;
  dc.send(JSON.stringify({ type: "msg", text }));
  sentCount++;
  setStat("stat-sent", sentCount);
  addMsg(text, "mine");
  msgInput.value = "";
  msgInput.style.height = "auto";
  sendTyping(false);
}

function sendTyping(on) {
  if (dc && dc.readyState === "open") dc.send(JSON.stringify({ type: "typing", on }));
}

function showTyping(on) {
  typingEl.textContent = on ? "Peer is typingâ€¦" : "";
}


function leaveRoom() {
  if (dc) { dc.close(); dc = null; }
  if (pc) { pc.close(); pc = null; }
  if (ws) { ws.close(); ws = null; }
  enableChat(false);
  setStatus("Disconnected");
  setStat("stat-role", "â€”"); setStat("stat-ice", "â€”"); setStat("stat-dc", "â€”");
  joinBtn.disabled = false;
  leaveBtn.disabled = true;
  roomInput.disabled = false;
  sentCount = 0; recvCount = 0;
  setStat("stat-sent", 0); setStat("stat-recv", 0);
  document.querySelectorAll(".arch-diagram .step").forEach(s => s.classList.remove("active"));
  addMsg("Left the room.", "sys");
}


joinBtn.onclick = () => {
  const room = roomInput.value.trim();
  if (!room) { roomInput.focus(); return; }
  joinBtn.disabled = true;
  leaveBtn.disabled = false;
  roomInput.disabled = true;
  connectSignal(room);
};

leaveBtn.onclick = leaveRoom;

sendBtn.onclick = sendMessage;

msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});


msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + "px";
  sendTyping(true);
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => sendTyping(false), 1500);
});

roomInput.addEventListener("keydown", e => { if (e.key === "Enter") joinBtn.click(); });
</script>
</body>
</html>